<include file="public/layout" />
<style>
  .goods_check{
  float: left;
  height: 24px;
  padding-top: 3px;
  margin-right: 5px;
}
.goods_check input{
  display: block;
  float: left;
}
.goods_check span{
  display: block;
  float: left;
  height: 16px;
  line-height: 15px;
}
</style>
</head>
<body style="overflow: auto;">
<div id="append_parent"></div>
<div id="ajaxwaitid"></div>
<div class="page">
  <div class="fixed-bar">
    <div class="item-title">
      <div class="subject">
        <h3>商户 - 添加修改商户</h3>
        <h5>添加或编辑商户</h5>
      </div>
    </div>
  </div>
  <form action="{:U('Business/addEditBusiness')}" method="post" class="form-horizontal" id="business_form">
    <div class="ncap-form-default">
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>商户名称</label>
        </dt>
        <dd class="opt">
          <input type="text" placeholder="商户名称" class="input-txt" name="shop_name" value="{$data.shop_name}">
          <span class="err" id="err_name1" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em></em>所在区域</label>
        </dt>
        <dd class="opt">省
          <select name="province" value="{$data.province}">
          <volist name="provinces" id="p">
          <option value="{$p.id}">{$p.name}</option>
          </volist>
          </select>
          市
          <select name="city" value="{$data.city}">
            <option value="52">北京</option>
          </select>
          区
          <select name="area" value="{$data.area}">
          </select>
          <span class="err" id="err_name" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>商户地址</label>
        </dt>
        <dd class="opt">
          <input type="text" placeholder="商户地址" class="input-txt" name="shop_address" value="{$data.shop_address}">
          <span class="err" id="err_mobile_name" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>纬度</label>
        </dt>
        <dd class="opt">
          <input type="text" placeholder="纬度" class="input-txt" name="shop_lat" value="{$data.shop_lat}" onkeyup="value=value.replace(/[^\-?\d.]/g,'')">
          <span class="err" id="err_name3" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>经度</label>
        </dt>
        <dd class="opt">
          <input type="text" placeholder="经度" class="input-txt" name="shop_lon" value="{$data.shop_lon}"  onkeyup="value=value.replace(/[^\-?\d.]/g,'')"> 
          <span class="err" id="err_name2" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>商户管理员名称</label>
        </dt>
        <dd class="opt">
          <input type="text" placeholder="商户管理员" class="input-txt" name="user_name" value="{$data.user_name}">
          <span class="err" id="err_name4" style="color:#F00; display:none;"></span>
          <p class="notic"></p>                          
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em>*</em>密码</label>
        </dt>
        <dd class="opt">
          <input type="password" placeholder="密码" class="input-txt" name="password" value="">
          <span class="err" id="err_name5" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
      </dl>
      <dl class="row">
        <dt class="tit"><em>*</em>商家logo</dt>
        <dd class="opt">
          <div class="input-file-show" id="divComUploadContainer">
            <span class="show">
                <a class="nyroModal" rel="gal" href="{$data.shop_logo}">
                    <i class="fa fa-picture-o" onmouseover="layer.tips('<img src={$data.shop_logo}>',this, {tips: [1, '#fff']});" onmouseout="layer.closeAll();"></i>
                </a>
            </span>           
            <span class="type-file-box">            
            <input type="text" id="imagetext" name="shop_logo" value="{$data.shop_logo}" class="type-file-text">            
            <input type="button" class="type-file-button" onClick="GetUploadify(1,'imagetext','category','')" value="上传图片" hidefocus="true" nc_type="change_site_logo" title="点击前方预览图可查看大图，点击按钮选择文件并提交表单后上传生效"/> 
            </span>
          </div>
          <div id="thumbnails" class="ncap-thumb-list">
            <h5 style="display: none;" id="shopLogo"><i class="fa fa-exclamation-circle"></i> 请上传图片格式文件。</h5>
            <ul>
            </ul>
          </div>
        </dd>
      </dl> 
      <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em></em>商户类型</label>
        </dt>

        <dd class="opt">
          <select name="shop_type" value="{$data.shop_type}">
          
          <option value="1"<if condition="$data.shop_type eq 1">selected</if>>一站式</option>
          
          <option value="2" <if condition="$data.shop_type eq 2">selected</if>>社区店</option>
          <option value="3"<if condition="$data.shop_type eq 3">selected</if>>维修厂</option>
          </select>
          <span class="err" id="err_name" style="color:#F00; display:none;"></span>
          <p class="notic"></p>
        </dd>
        
      </dl>
	  <dl class="row">
        <dt class="tit">
          <label for="t_mane"><em></em>是否使用</label>
        </dt>
        <dd class="opt">
          <div class="onoff">
            <label for="goods_category1" class="cb-enable <if condition="$data[status] eq 1">selected</if>">是</label>
            <label for="goods_category0" class="cb-disable <if condition="$data[status] eq 0">selected</if>">否</label>
            <input id="goods_category1" name="status" value="1" type="radio" <if condition="$data[status] eq 1"> checked="checked"</if>>
            <input id="goods_category0" name="status" value="0" type="radio" <if condition="$data[status] eq 0"> checked="checked"</if>>
          </div>
          <p class="notic">商户是否能使用</p>
        </dd>        
    </dl>
     <div class="bot"><a id="submitBtn" class="ncap-btn-big ncap-btn-green" href="JavaScript:void(0);">确认提交</a></div>
    </div>
    <input type="hidden" name="id" value="{$data.admin_id}">
  </form>
</div>
<script>  
    
/** 以下是编辑时默认选中某个商品分类*/
$(document).ready(function(){
  var checkNew=$("input[name='shop_name']").val().length
  if (checkNew>0) {
    var provNum="{$data.province}";
  var cityNum="{$data.city}";
  var areaNum="{$data.area}";
  $("select[name='province']").get(0).selectedIndex = provNum - 2 ;
  $.ajax({
    url:"{:U('Business/area')}",
    type:'post',
    dataType:"json",
    data:{id:"{$data.province}"},
    success:function(res){
      if (res.status==1) {
        var html = '';
        var cityCur="";
        $(res.info).each(function (index,item) {
          if (item.id==cityNum) {
            html+= '<option value="'+item.id+'" selected="selected">'+item.name+'</option>';
          }else{
            html+= '<option value="'+item.id+'">'+item.name+'</option>';
          }
        });
        $('select[name="city"]').html(html);
      }else{
         
      }
    }
  })
  $.ajax({
    url:"{:U('Business/area')}",
    type:'post',
    dataType:"json",
    data:{id:"{$data.city}"},
    success:function (res) {
      if (res.status==1) {
        var html = '';
        $(res.info).each(function (index,item) {
          if (item.id==areaNum) {
            html+= '<option value="'+item.id+'" selected="selected">'+item.name+'</option>';
          }else{
            html+= '<option value="'+item.id+'">'+item.name+'</option>';
          }
        });
        $('select[name="area"]').html(html);
      }else{
         
      }
    }
  });
  }
  
  
	$('#submitBtn').click(function () {
    const localUrl=window.location.href
    // console.log(localUrl.lastIndexOf("/id/"))
  $("#err_name1,#err_name2,#err_name3,#err_name4,#err_mobile_name,#err_name5,#shopLogo").hide();
  var form  = $('#business_form');
  var _url = form.attr('action');
  var shop_name=$("input[name='shop_name']").val(),shop_lat=$("input[name='shop_lat']").val(),shop_lon=$("input[name='shop_lon']").val(),shop_logo=$("input[name='shop_logo']").val(),shop_address=$("input[name='shop_address']").val(),user_name=$("input[name='user_name']").val(),password=$("input[name='password']").val();
  if (shop_name=="") {
    $("#err_name1").html("商户名称不能为空").show();return false;
  }else if (shop_address=="") {
    $("#err_mobile_name").html("商户地址不能为空").show();return false;
  }else if (shop_lat=="") {
    $("#err_name3").html("纬度不能为空").show();return false;
  }else if (shop_lon=="") {
    $("#err_name2").html("经度不能为空").show();return false;
  }else if (user_name=="") {
    $("#err_name4").html("商户管理员名称不能为空").show();return false;
  }else if (password==""&&localUrl.lastIndexOf("/id/")<0) {
      $("#err_name5").html("密码不能为空").show();return false;
  }else if (shop_logo=="") {
    $("#shopLogo").show();return false;
  }else{
    $.ajax({
      url:_url,
      type:'POST',
      data:form.serialize(),
      dataType:'json',
      success:function (res) {
       alert(res.msg);
       window.location.href="{:U('Business/index')}"; 
      }
    });
  }
  });

  $('select[name="province"]').change(function () {
    var val = $(this).val();
    $.ajax({
       url:"{:U('Business/area')}",
       type:'post',
       dataType:"json",
       data:{id:val},
       success:function (res) {
         if (res.status==1) {
          var html = '';
          $(res.info).each(function (index,item) {
            html+= '<option value="'+item.id+'">'+item.name+'</option>';
          });
          $('select[name="city"]').html(html);
          var valNew=$('select[name="city"]').val();
          $.ajax({
            async:false,
       url:"{:U('Business/area')}",
       type:'post',
       dataType:"json",
       data:{id:valNew},
       success:function (res) {
         if (res.status==1) {
          var html = '';
          $(res.info).each(function (index,item) {
            html+= '<option value="'+item.id+'">'+item.name+'</option>';
          });
          $('select[name="area"]').html(html);
         }else{
         
         }
       }
    });
         }else{
         
         }
       }
    });
  });

$('select[name="city"]').change(function () {
    var val = $(this).val();
    $.ajax({
       url:"{:U('Business/area')}",
       type:'post',
       dataType:"json",
       data:{id:val},
       success:function (res) {
         if (res.status==1) {
          var html = '';
          $(res.info).each(function (index,item) {
            html+= '<option value="'+item.id+'">'+item.name+'</option>';
          });
          $('select[name="area"]').html(html);
         }else{
         
         }
       }
    });
  });
});
//产品分类控制
$('.all').click(function(){
  if ($(this).attr("checked")=="checked") {
    $(this).parent().siblings().children('input').attr("checked","checked")
  }else{
    $(this).parent().siblings().children('input').removeAttr("checked")
  }
})
var oths=$('.all').parent().siblings().children('input')
oths.each(function(){
  $(this).click(function(){
    var chknum=$('.all').parent().siblings().children('input').size()
    var chk=0
    oths.each(function(){
      if ($(this).prop("checked")==true) {
        chk++;
      }
    })
    if (chk==chknum) {
      $('.all').prop("checked",true)
    }else{
      $('.all').prop("checked",false)
    }
  })
})
</script>
</body>
</html>